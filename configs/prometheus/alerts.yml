groups:
  - name: linkflow-alerts
    rules:
      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{namespace="linkflow",status=~"5.."}[5m])) 
          / sum(rate(http_requests_total{namespace="linkflow"}[5m])) * 100 > 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: High error rate detected
          description: "Error rate is {{ $value | printf \"%.2f\" }}% (threshold: 5%)"

      - alert: ServiceDown
        expr: up{namespace="linkflow"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: Service is down
          description: "{{ $labels.job }} has been down for more than 2 minutes"

      - alert: HighLatency
        expr: |
          histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{namespace="linkflow"}[5m])) by (le, service)) > 2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: High latency detected
          description: "P99 latency for {{ $labels.service }} is {{ $value | printf \"%.2f\" }}s"

      - alert: KafkaConsumerLag
        expr: kafka_consumer_group_lag{group="linkflow-group"} > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Kafka consumer lag is high
          description: "Consumer lag is {{ $value }} messages"

      - alert: PodCrashLooping
        expr: |
          increase(kube_pod_container_status_restarts_total{namespace="linkflow"}[10m]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Pod is crash looping
          description: "{{ $labels.pod }} has restarted {{ $value }} times in 10 minutes"

      - alert: HighCPUUsage
        expr: |
          sum(rate(container_cpu_usage_seconds_total{namespace="linkflow"}[5m])) by (pod) 
          / sum(kube_pod_container_resource_limits{namespace="linkflow",resource="cpu"}) by (pod) * 100 > 80
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: High CPU usage
          description: "{{ $labels.pod }} CPU usage is {{ $value | printf \"%.2f\" }}%"

      - alert: HighMemoryUsage
        expr: |
          sum(container_memory_working_set_bytes{namespace="linkflow"}) by (pod) 
          / sum(kube_pod_container_resource_limits{namespace="linkflow",resource="memory"}) by (pod) * 100 > 85
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: High memory usage
          description: "{{ $labels.pod }} memory usage is {{ $value | printf \"%.2f\" }}%"

      - alert: DatabaseConnectionPoolExhausted
        expr: pg_stat_activity_count{datname="linkflow"} / pg_settings_max_connections > 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: Database connection pool nearly exhausted
          description: "{{ $value | printf \"%.2f\" }}% of connections are in use"

      - alert: WorkflowExecutionFailureRate
        expr: |
          sum(rate(workflow_executions_total{status="failed"}[30m])) 
          / sum(rate(workflow_executions_total[30m])) * 100 > 10
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: High workflow execution failure rate
          description: "{{ $value | printf \"%.2f\" }}% of executions are failing"

      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: Disk space is running low
          description: "Only {{ $value | printf \"%.2f\" }}% disk space remaining"
