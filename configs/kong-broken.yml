_format_version: "3.0"
_transform: true

# Production-Ready Kong Configuration for LinkFlow (n8n Clone)
# Workflow Automation Platform API Gateway

services:
  # ==========================================
  # AUTH SERVICE - User Authentication & Authorization
  # ==========================================
  - name: auth-service
    url: http://auth-service:8001
    protocol: http
    host: auth-service
    port: 8001
    retries: 5
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      # Public auth endpoints (no JWT required)
      - name: auth-login
        paths:
          - /api/v1/auth/login
          - /api/v1/auth/register
          - /api/v1/auth/forgot-password
          - /api/v1/auth/reset-password
          - /api/v1/auth/verify-email
        strip_path: false
        preserve_host: true
        methods: [POST, OPTIONS]
        
      # OAuth endpoints
      - name: auth-oauth
        paths:
          - /api/v1/auth/oauth
          - /api/v1/auth/callback
        strip_path: false
        preserve_host: true
        methods: [GET, POST, OPTIONS]
        
      # Protected auth endpoints
      - name: auth-protected
        paths:
          - /api/v1/auth/refresh
          - /api/v1/auth/logout
          - /api/v1/auth/profile
          - /api/v1/auth/change-password
        strip_path: false
        preserve_host: true
        methods: [GET, POST, PUT, DELETE, OPTIONS]
        
    plugins:
      - name: cors
        config:
          origins:
            - "https://app.linkflow.io"
            - "https://linkflow.io"
            - "http://localhost:3000"  # Development
          methods: [GET, POST, PUT, DELETE, OPTIONS, PATCH]
          headers:
            - Authorization
            - Content-Type
            - X-Requested-With
            - X-CSRF-Token
          exposed_headers:
            - X-Request-Id
            - X-RateLimit-Limit
            - X-RateLimit-Remaining
            - X-RateLimit-Reset
          credentials: true
          max_age: 3600
          
      - name: rate-limiting
        config:
          minute: 60  # Strict for auth endpoints
          hour: 600
          policy: local
          fault_tolerant: true
          hide_client_headers: false
          
      - name: bot-detection
        config:
          allow: []
          deny: ["(bot|crawler|spider|scraper)"]

  # ==========================================
  # USER SERVICE - User Management
  # ==========================================
  - name: user-service
    url: http://user-service:8002
    protocol: http
    host: user-service
    port: 8002
    retries: 3
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: user-management
        paths:
          - /api/v1/users
          - /api/v1/teams
          - /api/v1/organizations
        strip_path: false
        preserve_host: true
        methods: [GET, POST, PUT, DELETE, PATCH, OPTIONS]
        
      - name: user-settings
        paths:
          - /api/v1/settings
          - /api/v1/preferences
          - /api/v1/api-keys
        strip_path: false
        preserve_host: true
        methods: [GET, POST, PUT, DELETE, OPTIONS]
        
    plugins:
      - name: jwt
        route: user-management
        config:
          secret_is_base64: false
          claims_to_verify: ["exp", "nbf"]
          key_claim_name: iss
          maximum_expiration: 86400  # 24 hours
          
      - name: acl
        route: user-management
        config:
          allow: ["authenticated", "admin"]
          hide_groups_header: true
          
      - name: rate-limiting
        config:
          minute: 300
          hour: 10000
          policy: local

  # ==========================================
  # WORKFLOW SERVICE - Core Workflow Engine
  # ==========================================
  - name: workflow-service
    url: http://workflow-service:8003
    protocol: http
    host: workflow-service
    port: 8003
    retries: 3
    connect_timeout: 60000
    write_timeout: 300000  # 5 minutes for complex workflows
    read_timeout: 300000
    routes:
      # Workflow CRUD operations
      - name: workflow-crud
        paths:
          - /api/v1/workflows
          - /api/v1/workflow-templates
          - /api/v1/workflow-versions
        strip_path: false
        preserve_host: true
        methods: [GET, POST, PUT, DELETE, PATCH, OPTIONS]
        
      # Workflow execution triggers
      - name: workflow-triggers
        paths:
          - /api/v1/workflows/execute
          - /api/v1/workflows/test
          - /api/v1/workflows/validate
        strip_path: false
        preserve_host: true
        methods: [POST, OPTIONS]
        
      # WebSocket for real-time updates
      - name: workflow-websocket
        paths:
          - /api/v1/workflows/ws
          - /api/v1/workflows/events
        strip_path: false
        preserve_host: true
        methods: [GET]
        protocols: [http, https]  # WebSocket upgrade handled via HTTP
        
      # Workflow sharing & collaboration
      - name: workflow-sharing
        paths:
          - /api/v1/workflows/share
          - /api/v1/workflows/public
          - /api/v1/workflows/import
          - /api/v1/workflows/export
        strip_path: false
        preserve_host: true
        methods: [GET, POST, OPTIONS]
        
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          claims_to_verify: ["exp"]
          
      - name: request-size-limiting
        config:
          allowed_payload_size: 50  # 50MB for workflow imports
          size_unit: megabytes
          
      - name: rate-limiting
        route: workflow-triggers
        config:
          minute: 100  # Limit workflow executions
          hour: 1000
          policy: local
          
      - name: proxy-cache
        route: workflow-crud
        config:
          request_method: ["GET"]
          response_code: [200, 301, 302]
          content_type: ["application/json"]
          cache_ttl: 300  # 5 minutes
          strategy: memory

  # ==========================================
  # EXECUTION SERVICE - Workflow Execution Engine
  # ==========================================
  - name: execution-service
    url: http://execution-service:8004
    protocol: http
    host: execution-service
    port: 8004
    retries: 2  # Less retries for executions
    connect_timeout: 60000
    write_timeout: 600000  # 10 minutes for long-running workflows
    read_timeout: 600000
    routes:
      # Execution management
      - name: execution-management
        paths:
          - /api/v1/executions
          - /api/v1/executions/logs
          - /api/v1/executions/metrics
        strip_path: false
        preserve_host: true
        methods: [GET, POST, PUT, DELETE, OPTIONS]
        
      # Server-Sent Events for live logs
      - name: execution-sse
        paths:
          - /api/v1/executions/stream
          - /api/v1/executions/live
        strip_path: false
        preserve_host: true
        methods: [GET]
        protocols: [http, https]
        
      # Execution control
      - name: execution-control
        paths:
          - /api/v1/executions/pause
          - /api/v1/executions/resume
          - /api/v1/executions/cancel
          - /api/v1/executions/retry
        strip_path: false
        preserve_host: true
        methods: [POST, OPTIONS]
        
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          
      - name: rate-limiting
        route: execution-control
        config:
          minute: 50  # Strict limits on execution control
          hour: 500
          policy: local
          
      - name: response-transformer
        config:
          add:
            headers:
              - X-Execution-Engine:LinkFlow-v1
              - Cache-Control:no-cache

  # ==========================================
  # NODE SERVICE - Workflow Nodes & Integrations
  # ==========================================
  - name: node-service
    url: http://node-service:8005
    protocol: http
    host: node-service
    port: 8005
    retries: 3
    connect_timeout: 60000
    write_timeout: 120000
    read_timeout: 120000
    routes:
      - name: node-registry
        paths:
          - /api/v1/nodes
          - /api/v1/nodes/categories
          - /api/v1/nodes/search
        strip_path: false
        preserve_host: true
        methods: [GET, OPTIONS]
        
      - name: node-credentials
        paths:
          - /api/v1/credentials
          - /api/v1/credentials/test
        strip_path: false
        preserve_host: true
        methods: [GET, POST, PUT, DELETE, OPTIONS]
        
      - name: node-custom
        paths:
          - /api/v1/nodes/custom
          - /api/v1/nodes/install
        strip_path: false
        preserve_host: true
        methods: [GET, POST, DELETE, OPTIONS]
        
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          
      - name: proxy-cache
        route: node-registry
        config:
          request_method: ["GET"]
          response_code: [200]
          content_type: ["application/json"]
          cache_ttl: 3600  # 1 hour for node registry
          strategy: memory

  # ==========================================
  # WEBHOOK SERVICE - External Triggers
  # ==========================================
  - name: webhook-service
    url: http://webhook-service:8006
    protocol: http
    host: webhook-service
    port: 8006
    retries: 1  # No retries for webhooks
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      # Public webhook endpoints (no auth)
      - name: webhook-public
        paths:
          - /webhook
          - /webhooks
        strip_path: false
        preserve_host: true
        methods: [GET, POST, PUT, DELETE, PATCH, OPTIONS]
        
      # Webhook management (requires auth)
      - name: webhook-management
        paths:
          - /api/v1/webhooks
          - /api/v1/webhook-logs
        strip_path: false
        preserve_host: true
        methods: [GET, POST, PUT, DELETE, OPTIONS]
        
    plugins:
      - name: rate-limiting
        route: webhook-public
        config:
          minute: 1000  # Higher limits for webhooks
          hour: 50000
          policy: local
          
      - name: jwt
        route: webhook-management
        config:
          secret_is_base64: false
          
      - name: request-size-limiting
        route: webhook-public
        config:
          allowed_payload_size: 10
          size_unit: megabytes

  # ==========================================
  # SCHEDULER SERVICE - Cron Jobs & Scheduled Workflows
  # ==========================================
  - name: scheduler-service
    url: http://scheduler-service:8007
    protocol: http
    host: scheduler-service
    port: 8007
    retries: 3
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: scheduler-routes
        paths:
          - /api/v1/schedules
          - /api/v1/cron-jobs
        strip_path: false
        preserve_host: true
        methods: [GET, POST, PUT, DELETE, OPTIONS]
        
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
          
      - name: rate-limiting
        config:
          minute: 100
          hour: 2000
          policy: local

  # ==========================================
  # NOTIFICATION SERVICE - Alerts & Notifications
  # ==========================================
  - name: notification-service
    url: http://notification-service:8008
    protocol: http
    host: notification-service
    port: 8008
    retries: 3
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: notification-routes
        paths:
          - /api/v1/notifications
          - /api/v1/notification-settings
        strip_path: false
        preserve_host: true
        methods: [GET, POST, PUT, DELETE, OPTIONS]
        
      # WebSocket for real-time notifications
      - name: notification-ws
        paths:
          - /api/v1/notifications/ws
        strip_path: false
        preserve_host: true
        methods: [GET]
        protocols: [http, https]
        
    plugins:
      - name: jwt
        config:
          secret_is_base64: false

  # ==========================================
  # PUBLIC ROUTES - No Authentication Required
  # ==========================================
  - name: public-routes
    url: http://kong:8001  # Kong admin API
    routes:
      # Health check endpoint
      - name: health-check
        paths:
          - /health
          - /api/health
        methods: [GET, HEAD]
        
      # API documentation
      - name: api-docs
        paths:
          - /api/docs
          - /api/swagger
          - /api/openapi.json
        methods: [GET]
        
      # Metrics endpoint for Prometheus
      - name: metrics
        paths:
          - /metrics
        methods: [GET]
        
    plugins:
      - name: request-transformer
        route: health-check
        config:
          replace:
            uri: /status
            
      - name: rate-limiting
        route: metrics
        config:
          minute: 60
          policy: local

# ==========================================
# GLOBAL PLUGINS - Applied to All Services
# ==========================================
plugins:
  # Request tracking
  - name: correlation-id
    config:
      header_name: X-Request-Id
      generator: uuid#v4
      echo_downstream: true

  # Security headers
  - name: response-transformer
    config:
      add:
        headers:
          - X-Frame-Options:DENY
          - X-Content-Type-Options:nosniff
          - X-XSS-Protection:1; mode=block
          - Strict-Transport-Security:max-age=31536000; includeSubDomains
          - Content-Security-Policy:default-src 'self'

  # Monitoring
  - name: prometheus
    config:
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

  # Request logging
  - name: http-log
    config:
      http_endpoint: http://logging-service:8080/logs
      method: POST
      timeout: 10000
      keepalive: 60000
      flush_timeout: 2
      retry_count: 10

  # Circuit breaker pattern (using proxy-cache as fallback)
  - name: proxy-cache
    config:
      request_method: ["GET", "HEAD"]
      response_code: [200, 301, 302]
      content_type: 
        - "application/json"
        - "application/xml"
        - "text/html"
      cache_ttl: 300
      strategy: memory
      memory:
        dictionary_name: linkflow_cache

# ==========================================
# CONSUMERS - API Users & Service Accounts
# ==========================================
consumers:
  # Internal service communication
  - username: internal-service-account
    custom_id: svc-internal-001
    tags: ["internal", "service-account"]
    keyauth_credentials:
      - key: ${INTERNAL_API_KEY}
    acls:
      - group: internal-services
      
  # External API users
  - username: api-user-free
    custom_id: usr-free-tier
    tags: ["external", "free-tier"]
    jwt_secrets:
      - key: ${JWT_SECRET_FREE}
        algorithm: HS256
    acls:
      - group: free-users
      
  - username: api-user-pro
    custom_id: usr-pro-tier
    tags: ["external", "pro-tier"]
    jwt_secrets:
      - key: ${JWT_SECRET_PRO}
        algorithm: HS256
    acls:
      - group: pro-users
      
  - username: api-user-enterprise
    custom_id: usr-enterprise
    tags: ["external", "enterprise"]
    jwt_secrets:
      - key: ${JWT_SECRET_ENTERPRISE}
        algorithm: RS256
        rsa_public_key: ${RSA_PUBLIC_KEY}
    acls:
      - group: enterprise-users
      
  # Monitoring & observability
  - username: monitoring-prometheus
    custom_id: mon-prometheus
    tags: ["monitoring", "prometheus"]
    keyauth_credentials:
      - key: ${PROMETHEUS_API_KEY}
    acls:
      - group: monitoring
      
  # Webhook service account
  - username: webhook-service
    custom_id: svc-webhook
    tags: ["webhook", "automation"]
    keyauth_credentials:
      - key: ${WEBHOOK_API_KEY}
    acls:
      - group: webhook-services

# ==========================================
# NOTES FOR PRODUCTION DEPLOYMENT:
# ==========================================
# 1. Replace environment variables (${VAR_NAME}) with actual values
# 2. Update CORS origins with your actual domains
# 3. Configure proper JWT secrets and RSA keys
# 4. Set up external logging service endpoint
# 5. Adjust rate limits based on your tier structure
# 6. Configure SSL/TLS certificates for HTTPS
# 7. Set up proper monitoring and alerting
# 8. Implement proper backup and disaster recovery
# 9. Use Kong with PostgreSQL for advanced features
# 10. Consider Kong Enterprise for additional features
